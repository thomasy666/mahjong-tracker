<!DOCTYPE html>
<html lang="{{ lang_code }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t['title'] }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-green: #00f260;
            --accent-blue: #0575E6;
            --accent-red: #ff416c;
            --shadow-glow: 0 0 15px rgba(5, 117, 230, 0.3);
        }

        body {
            background: var(--bg-grad);
            color: var(--text-main);
            font-family: 'Exo 2', sans-serif;
            min-height: 100vh;
        }

        /* Text Overrides */
        .text-muted { color: var(--text-muted) !important; }
        .text-dark { color: #fff !important; } /* Invert text-dark for dark mode */
        
        .score-positive { color: #4ade80; font-weight: bold; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
        .score-negative { color: #f87171; font-weight: bold; text-shadow: 0 0 5px rgba(248, 113, 113, 0.5); }
        .delta-positive { color: #4ade80; }
        .delta-negative { color: #f87171; }

        .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 5px currentColor;
        }
        .avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.2);
            margin-right: 8px;
        }

        /* Glassmorphism Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--card-border);
            color: var(--text-main);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .card-header {
            background: rgba(0, 0, 0, 0.2) !important;
            border-bottom: var(--card-border);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }
        
        /* Tint headers subtly instead of full solid bg */
        .card-header.bg-primary { border-left: 4px solid #4facfe; color: #4facfe; }
        .card-header.bg-success { border-left: 4px solid var(--accent-green); color: var(--accent-green); }
        .card-header.bg-info { border-left: 4px solid #00c6ff; color: #00c6ff; }
        .card-header.bg-secondary { border-left: 4px solid #a8c0ff; color: #a8c0ff; }

        .list-group-item {
            background: transparent;
            color: var(--text-main);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Inputs */
        .form-control, .form-select, .input-group-text {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(0, 0, 0, 0.6);
            border-color: var(--accent-blue);
            color: #fff;
            box-shadow: 0 0 0 0.25rem rgba(5, 117, 230, 0.25);
        }
        .form-control::placeholder { color: rgba(255,255,255,0.4); }

        /* Buttons */
        .btn {
            border-radius: 30px;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        .btn-success {
            background: linear-gradient(90deg, #11998e, #38ef7d);
            border: none;
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
        }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4); }
        
        .btn-info {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            border: none;
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3);
        }
        
        .btn-dark {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-dark:hover { background: rgba(255,255,255,0.2); }

        .btn-outline-dark {
            color: #e0e0e0;
            border-color: rgba(255,255,255,0.3);
        }
        .btn-outline-dark:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        /* Table */
        .table { color: var(--text-main); --bs-table-bg: transparent; }
        .table thead th {
            background: rgba(0, 0, 0, 0.3);
            color: var(--accent-blue);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .table td { border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Modals */
        .modal-content {
            background: #1e1e2f;
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .btn-close { filter: invert(1); }

        /* Custom Dice Styles */
        .scene {
            width: 60px;
            height: 60px;
            perspective: 600px;
            display: inline-block;
        }
        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: translateZ(-30px);
            transition: transform 1.5s ease-out;
        }
        .cube__face {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #f0f0f0;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 4px;
            gap: 2px;
            backface-visibility: hidden;
        }
        /* Face Positioning */
        .cube__face--1  { transform: rotateY(  0deg) translateZ(30px); }
        .cube__face--2  { transform: rotateY( 90deg) translateZ(30px); } /* Right */
        .cube__face--3  { transform: rotateY(180deg) translateZ(30px); } /* Back */
        .cube__face--4  { transform: rotateY(-90deg) translateZ(30px); } /* Left */
        .cube__face--5  { transform: rotateX( 90deg) translateZ(30px); } /* Top */
        .cube__face--6  { transform: rotateX(-90deg) translateZ(30px); } /* Bottom */

        .pip {
            background-color: #222;
            border-radius: 50%;
            align-self: center;
            justify-self: center;
            width: 10px;
            height: 10px;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.5);
        }
        .pip.red { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
        .pip.big { width: 18px; height: 18px; }

        .recorder-lock-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px 15px;
        }
        .recorder-name-neon {
            color: #00c6ff;
            text-shadow: 0 0 5px rgba(0, 198, 255, 0.5);
            font-weight: 600;
        }

        /* Avatar Zoom */
        .avatar-zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            display: none; /* hidden by default */
            justify-content: center;
            align-items: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        .avatar-zoom-img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .avatar-zoom-overlay.active { display: flex; animation: fadeIn 0.3s ease-out; }
        .avatar-zoom-overlay.active .avatar-zoom-img { transform: scale(1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.2);
            margin-right: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .avatar-small:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(255,255,255,0.4);
            z-index: 10;
        }
        
        @keyframes bop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        .avatar-bop {
            animation: bop 0.8s infinite ease-in-out;
        }

        /* Podium Styles */
        .podium-container {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 1rem;
            height: 360px;
            padding-bottom: 20px;
            margin-top: 40px;
        }
        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            text-align: center;
            position: relative;
        }
        /* Visual Order: 2nd (Left), 1st (Center), 3rd (Right) */
        .podium-item.rank-1 { order: 2; z-index: 10; }
        .podium-item.rank-2 { order: 1; }
        .podium-item.rank-3 { order: 3; }

        .podium-bar {
            width: 80px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            color: rgba(255,255,255,0.8);
            font-weight: 700;
            font-size: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            padding-top: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .podium-item.rank-1 .podium-bar { 
            height: 180px; 
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); 
            width: 100px;
        }
        .podium-item.rank-2 .podium-bar { 
            height: 130px; 
            background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%); 
        }
        .podium-item.rank-3 .podium-bar { 
            height: 90px; 
            background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%); 
        }

        .podium-avatar-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            object-fit: cover;
            margin-bottom: 10px;
            background: #444;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }
        .podium-avatar-img:hover { transform: scale(1.1); }
        
        .podium-item.rank-1 .podium-avatar-img { 
            width: 90px; 
            height: 90px; 
            border: 4px solid #FFD700; 
        }
        .podium-item.rank-2 .podium-avatar-img { border-color: #C0C0C0; }
        .podium-item.rank-3 .podium-avatar-img { border-color: #CD7F32; }

        .podium-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-size: 1.1rem;
        }
        .podium-score {
            font-size: 0.9rem;
            opacity: 0.8;
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .btn-magic {
            color: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }
        .btn-magic:hover:not(:disabled) {
            background: rgba(255, 215, 0, 0.1);
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            transform: scale(1.05);
        }
        .btn-magic:disabled {
            color: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.1);
            box-shadow: none;
        }

        /* Validation Box Futuristic Styles */
        .validation-box-success {
            background: rgba(0, 242, 96, 0.1) !important;
            border: 1px solid rgba(0, 242, 96, 0.3);
            color: var(--accent-green) !important;
            box-shadow: 0 0 15px rgba(0, 242, 96, 0.1);
        }
        .validation-box-error {
            background: rgba(255, 65, 108, 0.1) !important;
            border: 1px solid rgba(255, 65, 108, 0.3);
            color: #ff4b2b !important;
            box-shadow: 0 0 15px rgba(255, 65, 108, 0.1);
        }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-center mb-0">üÄÑ {{ t['title'] }}</h1>
        <div class="d-flex align-items-center gap-2">
            {% if admin_mode %}
            <span class="badge bg-danger">{{ t['admin_mode_active'] }}</span>
            <a href="/admin/logout" class="btn btn-outline-danger btn-sm">
                üö™ {{ t['exit_admin_mode'] }}
            </a>
            {% else %}
            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#adminLoginModal">
                üîë {{ t['enter_admin_mode'] }}
            </button>
            {% endif %}
            
            <button class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#adminSettingsModal">
                ‚öôÔ∏è {{ t['settings'] }}
            </button>
            <a href="/set_language/{{ 'zh' if lang_code == 'en' else 'en' }}" class="btn btn-outline-dark btn-sm">
                {{ t['language'] }}
            </a>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row g-4">
        <!-- LEFT COLUMN: Standings & Input -->
        <div class="col-md-6">
            
            <!-- Current Standings -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ t['standings'] }}</h5>
                    {% if admin_mode %}
                    <form action="/reset" method="POST" onsubmit="return confirm('{{ t['confirm_reset'] }}');" class="d-inline">
                        <button class="btn btn-sm btn-outline-light">{{ t['reset_game'] }}</button>
                    </form>
                    {% else %}
                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#resetGameModal">{{ t['reset_game'] }}</button>
                    {% endif %}
                </div>
                <ul class="list-group list-group-flush">
                    {% for name, score, color in standings %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if player_avatars.get(name) %}
                            <img src="{{ url_for('static', filename='avatars/' + player_avatars[name]) }}" class="avatar-small" onclick="openZoom(this.src)">
                            {% else %}
                            <span class="color-dot" style="background-color: {{ color }};"></span>
                            {% endif %}
                            <span class="fw-bold">{{ name }}</span>
                        </div>
                        <span class="{{ 'score-positive' if score >= 0 else 'score-negative' }}">
                            {{ score }}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- New Round Entry -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">{{ t['record_round'] }}</h5>
                </div>
                <div class="card-body">
                    <form action="/add_round" method="POST" id="scoreForm">
                        <div class="mb-3">
                            <label class="form-label small text-muted">{{ t['recorded_by'] }}</label>
                            
                            {% if session.get('recorder_name') %}
                                <!-- LOCKED STATE -->
                                <div class="d-flex justify-content-between align-items-center recorder-lock-box">
                                    <div>
                                        <span class="text-muted small">{{ t['locked_as'] }}:</span>
                                        <span class="recorder-name-neon">{{ session.get('recorder_name') }}</span>
                                    </div>
                                    {% if admin_mode %}
                                    <form action="/change_recorder" method="POST" class="d-inline">
                                         <button class="btn btn-sm btn-outline-info px-3">{{ t['unlock'] }}</button>
                                    </form>
                                    {% else %}
                                    <button type="button" class="btn btn-sm btn-outline-info px-3" data-bs-toggle="modal" data-bs-target="#unlockRecorderModal">
                                        {{ t['unlock'] }}
                                    </button>
                                    {% endif %}
                                </div>
                                <input type="hidden" name="recorder_name" value="{{ session.get('recorder_name') }}">
                            {% else %}
                                <!-- UNLOCKED STATE -->
                                <select name="recorder_name" class="form-select form-select-sm" required>
                                    <option value="" disabled selected>-- Select Your Name --</option>
                                    {% for name, score, color in standings %}
                                    <option value="{{ name }}">{{ name }}</option>
                                    {% endfor %}
                                </select>
                            {% endif %}
                        </div>

                        <div class="row g-2">
                            {% for name, score, color in standings %}
                            <div class="col-6">
                                <label class="form-label small" style="color: {{ color }}; font-weight: bold;">{{ name }}</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: {{ color }}; border-color: {{ color }}; width: 10px; padding: 0;"></span>
                                    <input type="number" class="form-control score-input" 
                                           name="score_{{ name }}" placeholder="0" step="1">
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="mt-3 p-2 rounded text-center" id="validationBox">
                            <strong>{{ t['total_delta'] }}: <span id="totalDelta">0</span></strong>
                            <div id="validationMsg" class="small">{{ t['must_equal_zero'] }}</div>
                            <button type="button" class="btn btn-sm btn-magic mt-2" id="autoBalanceBtn" disabled>
                                ü™Ñ {{ t['auto_balance'] }}
                            </button>
                        </div>

                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-success" id="submitBtn" disabled>{{ t['submit_round'] }}</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Player Management -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">{{ t['manage_players'] }}</h5>
                </div>
                <div class="card-body">
                    <!-- Add Player -->
                    <form action="/players/add" method="POST" class="input-group mb-3">
                        <input type="text" name="name" class="form-control" placeholder="{{ t['new_player_placeholder'] }}" required>
                        <button class="btn btn-outline-secondary" type="submit">{{ t['add'] }}</button>
                    </form>

                    <!-- Manage Existing Players -->
                    <h6 class="small text-muted mt-3">{{ t['manage_players'] }}</h6>
                    <ul class="list-group list-group-flush">
                        {% for name in players %}
                        <li class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    {% if player_avatars.get(name) %}
                                    <img src="{{ url_for('static', filename='avatars/' + player_avatars[name]) }}" class="avatar-small" onclick="openZoom(this.src)">
                                    {% endif %}
                                    <span class="fw-bold" style="color: {{ player_colors.get(name, '#000') }};">
                                        {{ name }}
                                    </span>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#edit-{{ loop.index }}">
                                        {{ t['rename'] }}
                                    </button>
                                    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#color-{{ loop.index }}">
                                        üé®
                                    </button>
                                    <button class="btn btn-outline-info" data-bs-toggle="collapse" data-bs-target="#avatar-{{ loop.index }}">
                                        üì∑
                                    </button>
                                    <button class="btn btn-outline-danger" data-bs-toggle="collapse" data-bs-target="#remove-{{ loop.index }}">
                                        &times;
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Rename Form -->
                            <div class="collapse mt-2" id="edit-{{ loop.index }}">
                                <form action="/players/rename" method="POST" class="card card-body bg-light p-2">
                                    <input type="hidden" name="old_name" value="{{ name }}">
                                    <div class="mb-2">
                                        <input type="text" name="new_name" class="form-control form-control-sm" placeholder="{{ t['new_player_placeholder'] }}" required>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary w-100">{{ t['rename'] }}</button>
                                </form>
                            </div>

                            <!-- Color Form -->
                            <div class="collapse mt-2" id="color-{{ loop.index }}">
                                <form action="/players/color" method="POST" class="card card-body bg-light p-2">
                                    <input type="hidden" name="name" value="{{ name }}">
                                    <div class="mb-2 d-flex align-items-center">
                                        <label class="me-2 small">{{ t['label_color'] }}:</label>
                                        <input type="color" name="color" class="form-control form-control-color" value="{{ player_colors.get(name, '#000000') }}" title="{{ t['choose_color'] }}">
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-secondary w-100">{{ t['save_color'] }}</button>
                                </form>
                            </div>

                            <!-- Avatar Form -->
                            <div class="collapse mt-2" id="avatar-{{ loop.index }}">
                                <form action="/players/avatar" method="POST" enctype="multipart/form-data" class="card card-body bg-light p-2">
                                    <input type="hidden" name="name" value="{{ name }}">
                                    <div class="mb-2">
                                        <label class="form-label small">{{ t['upload_avatar'] }}</label>
                                        <input type="file" name="avatar" class="form-control form-control-sm" accept="image/*" required>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-info w-100">{{ t['upload_avatar'] }}</button>
                                </form>
                            </div>

                            <!-- Remove Form -->
                            <div class="collapse mt-2" id="remove-{{ loop.index }}">
                                <form action="/players/remove" method="POST" class="card card-body bg-light p-2" onsubmit="return confirm('{{ t['confirm_remove'] }} {{name}}?');">
                                    <input type="hidden" name="name" value="{{ name }}">
                                    <p class="small mb-2">{{ t['confirm_remove'] }} {{ name }}?</p>
                                    {% if is_locked(name) and not admin_mode %}
                                    <div class="mb-2">
                                        <input type="password" name="admin_code" class="form-control form-control-sm" placeholder="{{ t['admin_code'] }}" required>
                                    </div>
                                    {% endif %}
                                    <button type="submit" class="btn btn-sm btn-danger w-100">{{ t['remove_player'] }}</button>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN: Ledger History -->
        <div class="col-md-6">
            
            <!-- Dice Roller -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üé≤ {{ t['roll_dice'] }}</h5>
                </div>
                <div class="card-body text-center">
                    <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                        <div class="scene">
                            <div id="cube1" class="cube">
                                <div class="cube__face cube__face--1"></div>
                                <div class="cube__face cube__face--2"></div>
                                <div class="cube__face cube__face--3"></div>
                                <div class="cube__face cube__face--4"></div>
                                <div class="cube__face cube__face--5"></div>
                                <div class="cube__face cube__face--6"></div>
                            </div>
                        </div>
                        <div class="scene">
                            <div id="cube2" class="cube">
                                <div class="cube__face cube__face--1"></div>
                                <div class="cube__face cube__face--2"></div>
                                <div class="cube__face cube__face--3"></div>
                                <div class="cube__face cube__face--4"></div>
                                <div class="cube__face cube__face--5"></div>
                                <div class="cube__face cube__face--6"></div>
                            </div>
                        </div>
                        <div id="diceSum" class="display-4 mb-0 fw-bold text-dark ms-5">?</div>
                    </div>
                    <div id="wallDirDisplay" class="h5 text-muted mb-3" style="min-height: 1.2em;">&nbsp;</div>

                    <!-- Wall Visual -->
                    <div class="d-flex justify-content-center mb-3">
                        <svg id="mahjongTable" width="200" height="200" viewBox="0 0 200 200" style="background: rgba(0,0,0,0.2); border-radius: 50%; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);">
                            <!-- Center Label -->
                            <text x="100" y="105" text-anchor="middle" fill="#aaa" font-size="12" style="opacity: 0.5; font-weight: bold;">{{ t['table_label'] }}</text>
                            
                            <!-- Walls (0:Bottom/Self, 1:Right, 2:Top/Across, 3:Left) -->
                            <!-- Note: Rotations ensure local +X is always the "Right" end of the wall from that player's perspective -->
                            
                            <!-- Bottom (Self) -->
                            <g id="wall-0" transform="translate(100, 170)">
                                <rect x="-60" y="-8" width="120" height="16" rx="2" fill="#444" stroke="#666" stroke-width="1"></rect>
                                <text x="0" y="4" text-anchor="middle" fill="#fff" font-size="9">{{ t['dir_self'] }}</text>
                            </g>
                            <!-- Right -->
                            <g id="wall-1" transform="translate(170, 100) rotate(90)">
                                <rect x="-60" y="-8" width="120" height="16" rx="2" fill="#444" stroke="#666" stroke-width="1"></rect>
                                <text x="0" y="4" text-anchor="middle" fill="#fff" font-size="9">{{ t['dir_right'] }}</text>
                            </g>
                            <!-- Top (Across) -->
                            <g id="wall-2" transform="translate(100, 30) rotate(180)">
                                <rect x="-60" y="-8" width="120" height="16" rx="2" fill="#444" stroke="#666" stroke-width="1"></rect>
                                <text x="0" y="4" text-anchor="middle" fill="#fff" font-size="9">{{ t['dir_across'] }}</text>
                            </g>
                            <!-- Left -->
                            <g id="wall-3" transform="translate(30, 100) rotate(-90)">
                                <rect x="-60" y="-8" width="120" height="16" rx="2" fill="#444" stroke="#666" stroke-width="1"></rect>
                                <text x="0" y="4" text-anchor="middle" fill="#fff" font-size="9">{{ t['dir_left'] }}</text>
                            </g>

                            <!-- Indicator Arrow (appended to active wall group dynamically or positioned globally) -->
                            <!-- We will render a global marker for simplicity in animation, or clone it -->
                        </svg>
                    </div>

                    <button class="btn btn-info text-white" onclick="rollDice()">{{ t['roll_dice'] }}</button>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ t['history'] }}</h5>
                    {% if admin_mode %}
                    <form action="/undo" method="POST" class="d-inline">
                        <button class="btn btn-sm btn-warning">{{ t['undo_last'] }}</button>
                    </form>
                    {% else %}
                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#undoRoundModal">{{ t['undo_last'] }}</button>
                    {% endif %}
                </div>
                <div class="card-body p-0 overflow-auto" style="max-height: 60vh;">
                    {% if not ledger %}
                        <div class="p-4 text-center text-muted">{{ t['no_rounds'] }}</div>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="px-3">#</th>
                                        <th class="text-muted small">{{ t['recorder'] }}</th>
                                        {% for name in history_headers %}
                                        <th class="text-center" style="color: {{ player_colors.get(name, '#FFF') }};">{{ name }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for round in ledger %}
                                    <tr>
                                        <td class="px-3 text-muted small">{{ round.id }}</td>
                                        <td class="text-muted small" title="IP: {{ round.get('ip', 'N/A') }}">
                                            {{ round.get('recorder', '-') }}
                                        </td>
                                        {% for name in history_headers %}
                                        <td class="text-center">
                                            {% set delta = round.deltas.get(name, 0) %}
                                            <span class="{{ 'delta-positive' if delta > 0 else 'delta-negative' if delta < 0 else 'text-muted' }}">
                                                {{ delta if delta != 0 else '-' }}
                                            </span>
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Statistics -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-secondary text-white border-0">
                    <h5 class="mb-0">üìä {{ t['statistics'] }}</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-3">{{ t['player'] }}</th>
                                <th class="text-center">{{ t['win_rate'] }}</th>
                                <th class="text-center">{{ t['rounds_short'] }}</th>
                                <th class="text-end">{{ t['highest_score'] }}</th>
                                <th class="text-end">{{ t['lowest_score'] }}</th>
                                <th class="text-end pe-3">{{ t['avg_score'] }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in statistics %}
                            <tr>
                                <td class="ps-3">
                                    <div class="d-flex align-items-center">
                                        {% if player_avatars.get(s.name) %}
                                        <img src="{{ url_for('static', filename='avatars/' + player_avatars[s.name]) }}" class="avatar-small" onclick="openZoom(this.src)">
                                        {% else %}
                                        <span class="color-dot" style="background-color: {{ s.color }};"></span>
                                        {% endif %}
                                        <strong style="color: {{ s.color }};">{{ s.name }}</strong>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge {{ 'bg-success' if s.win_rate >= 50 else 'bg-warning' if s.win_rate >= 25 else 'bg-danger' }}">
                                        {{ s.win_rate }}%
                                    </span>
                                </td>
                                <td class="text-center text-white">{{ s.rounds }}</td>
                                <td class="text-end text-success">{{ s.best }}</td>
                                <td class="text-end text-danger">{{ s.worst }}</td>
                                <td class="text-end pe-3 {{ 'text-success' if s.avg > 0 else 'text-danger' }}">{{ s.avg }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- End Game Modal -->
<div class="modal fade" id="endGameModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="modal-body">
        <div class="display-1 mb-4">üèÜ</div>
        <h2 class="mb-4 text-uppercase fw-bold" style="letter-spacing: 2px; color: #fff;">{{ t['congratulations'] }}</h2>
        <div id="podiumBox" class="podium-container"></div>
        <p class="lead text-muted mt-3">{{ t['game_over_msg'] }}</p>
        <h1 class="display-4 fw-bold text-success" id="winnerName"></h1>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">{{ t['close'] }}</button>
      </div>
    </div>
  </div>
</div>

<div class="container pb-5">
    <button class="btn btn-lg btn-dark w-100 py-3 shadow" onclick="triggerEndGame()">
        {{ t['end_game'] }}
    </button>
</div>

<!-- Avatar Zoom Overlay -->
<div id="avatarZoomOverlay" class="avatar-zoom-overlay" onclick="closeZoom()">
    <img id="avatarZoomImg" class="avatar-zoom-img" src="">
</div>

<!-- Unlock Recorder Modal -->
<div class="modal fade" id="unlockRecorderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fs-6">{{ t['change_recorder_title'] }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="/change_recorder" method="POST">
            <label class="form-label small">{{ t['enter_admin_code'] }}</label>
            <input type="password" name="admin_code" class="form-control mb-3" required>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-sm">{{ t['unlock'] }}</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Reset Game Modal -->
<div class="modal fade" id="resetGameModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fs-6">{{ t['reset_requires_code'] }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">{{ t['confirm_reset'] }}</p>
        <form action="/reset" method="POST">
            <label class="form-label small">{{ t['enter_code_to_reset'] }}</label>
            <input type="password" name="admin_code" class="form-control mb-3" required>
            <div class="d-grid">
                <button type="submit" class="btn btn-danger btn-sm">{{ t['reset_game'] }}</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Admin Settings Modal -->
<div class="modal fade" id="adminSettingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fs-6">{{ t['change_admin_code'] }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="/settings/admin" method="POST">
            <div class="mb-3">
                <label class="form-label small">{{ t['current_admin_code'] }}</label>
                <input type="password" name="old_code" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label small">{{ t['new_admin_code'] }}</label>
                <input type="password" name="new_code" class="form-control" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-sm">{{ t['confirm_admin_change'] }}</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Undo Round Modal -->
<div class="modal fade" id="undoRoundModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title fs-6">{{ t['undo_requires_code'] }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="/undo" method="POST">
            <label class="form-label small">{{ t['enter_code_to_undo'] }}</label>
            <input type="password" name="admin_code" class="form-control mb-3" required>
            <div class="d-grid">
                <button type="submit" class="btn btn-warning btn-sm">{{ t['undo_last'] }}</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div class="modal fade" id="adminLoginModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fs-6">{{ t['admin_login_title'] }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="/admin/login" method="POST">
            <input type="password" name="admin_code" class="form-control mb-3" placeholder="{{ t['admin_code'] }}" required>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-sm">{{ t['confirm_admin_login'] }}</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    // Wall Direction Translations
    const WALL_DIRS = [
        "{{ t['dir_self'] }}",
        "{{ t['dir_right'] }}",
        "{{ t['dir_across'] }}",
        "{{ t['dir_left'] }}"
    ];
    const WALL_START_LABEL = "{{ t['wall_start'] }}";

    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.score-input');
        const totalDisplay = document.getElementById('totalDelta');
        const submitBtn = document.getElementById('submitBtn');
        const validationBox = document.getElementById('validationBox');
        const validationMsg = document.getElementById('validationMsg');
        const autoBtn = document.getElementById('autoBalanceBtn');
        
        // Load translated strings
        const msgPerfect = "{{ t['js_perfect'] }}";
        const msgErrorTemplate = "{{ t['js_error'] }}";

        function calculateTotal() {
            let sum = 0;
            inputs.forEach(input => {
                const val = parseInt(input.value) || 0;
                sum += val;
            });
            return sum;
        }

        function updateUI() {
            const sum = calculateTotal();
            totalDisplay.textContent = sum;

            if (sum === 0) {
                validationBox.className = "mt-3 p-3 rounded text-center validation-box-success";
                validationMsg.textContent = msgPerfect;
                submitBtn.disabled = false;
                autoBtn.disabled = true;
            } else {
                validationBox.className = "mt-3 p-3 rounded text-center validation-box-error";
                // Simple template replacement for {sum}
                validationMsg.textContent = msgErrorTemplate.replace('{sum}', sum);
                submitBtn.disabled = true;

                // Auto Balance Check
                let zeroInputs = [];
                inputs.forEach(input => {
                    // Check if input is empty or 0. Using simple loose check or parse
                    const val = input.value === '' ? 0 : parseInt(input.value);
                    if (val === 0 || isNaN(val)) zeroInputs.push(input);
                });

                if (zeroInputs.length === 1) {
                    autoBtn.disabled = false;
                    autoBtn.onclick = function() {
                        // Current sum is what we need to offset.
                        // The zero input currently contributes 0 to sum.
                        // We set it to -sum.
                        zeroInputs[0].value = -sum;
                        // Trigger update
                        updateUI();
                    };
                } else {
                    autoBtn.disabled = true;
                }
            }
        }

        inputs.forEach(input => {
            input.addEventListener('input', updateUI);
        });

        // Initial check
        updateUI();
        initDice();
    });

    // Track current rotation to ensure we always spin forward
    const diceState = {
        1: {x: 0, y: 0},
        2: {x: 0, y: 0}
    };

    function initDice() {
        [1, 2].forEach(id => {
            const cube = document.getElementById(`cube${id}`);
            if(!cube) return;
            for(let i=1; i<=6; i++) {
                const face = cube.querySelector(`.cube__face--${i}`);
                if(face) face.innerHTML = getDieHTML(i);
            }
            // Set initial flat view
            cube.style.transform = `rotateX(${diceState[id].x}deg) rotateY(${diceState[id].y}deg)`;
        });
    }

    function openZoom(src) {
        document.getElementById('avatarZoomImg').src = src;
        const overlay = document.getElementById('avatarZoomOverlay');
        overlay.classList.add('active');
    }
    
    function closeZoom() {
        document.getElementById('avatarZoomOverlay').classList.remove('active');
    }

    function triggerEndGame() {
        // 1. Gather all players
        const standingsItems = document.querySelectorAll('.list-group-item');
        let players = [];
        standingsItems.forEach(item => {
            const nameEl = item.querySelector('.fw-bold');
            const scoreEl = item.querySelector('.score-positive, .score-negative');
            const avatarEl = item.querySelector('.avatar-small');
            const src = avatarEl ? avatarEl.src : null;
            
            if (nameEl && scoreEl) {
                players.push({
                    name: nameEl.innerText.trim(),
                    score: parseInt(scoreEl.innerText),
                    src: src
                });
            }
        });

        // 2. Sort by score descending
        players.sort((a, b) => b.score - a.score);

        // Update Winner Name Display
        if (players.length > 0) {
             const maxScore = players[0].score;
             const winners = players.filter(p => p.score === maxScore);
             document.getElementById('winnerName').innerText = winners.map(w => w.name).join(' & ');
        } else {
             document.getElementById('winnerName').innerText = '';
        }

        // 3. Take Top 3
        const top3 = players.slice(0, 3);

        // 4. Build Podium HTML
        const podiumContainer = document.getElementById('podiumBox');
        podiumContainer.innerHTML = '';

        if (top3.length === 0) {
            podiumContainer.innerHTML = '<div class="text-muted">No players found.</div>';
        }

        top3.forEach((p, index) => {
            const rank = index + 1;
            const bopClass = rank === 1 ? 'avatar-bop' : '';
            
            // Create podium item
            const item = document.createElement('div');
            item.className = `podium-item rank-${rank}`;
            
            // Avatar HTML
            let imgHtml = '';
            if (p.src) {
                imgHtml = `<img src="${p.src}" class="podium-avatar-img ${bopClass}" onclick="openZoom(this.src)">`;
            } else {
                // Placeholder
                imgHtml = `<div class="podium-avatar-img ${bopClass} d-flex align-items-center justify-content-center text-dark fw-bold fs-4 bg-light">
                    ${p.name.charAt(0).toUpperCase()}
                </div>`;
            }
            
            // Name & Score HTML
            const infoHtml = `
                <div class="podium-name">
                    ${p.name}<br>
                    <span class="podium-score">${p.score}</span>
                </div>`;
            
            // Bar HTML
            const barHtml = `<div class="podium-bar">${rank}</div>`;
            
            item.innerHTML = imgHtml + infoHtml + barHtml;
            podiumContainer.appendChild(item);
        });
        
        // 5. Show Modal
        const myModal = new bootstrap.Modal(document.getElementById('endGameModal'));
        myModal.show();

        // 6. Trigger Fireworks
        launchFireworks();
    }

    function launchFireworks() {
        const duration = 5 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

        function random(min, max) {
          return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function() {
          const timeLeft = animationEnd - Date.now();

          if (timeLeft <= 0) {
            return clearInterval(interval);
          }

          const particleCount = 50 * (timeLeft / duration);
          // since particles fall down, start a bit higher than random
          confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
          confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);
    }

    function getDieHTML(val) {
        // Helper to create pip html: r/c are row/col indices (1-based)
        const mkPip = (r, c, cls='') => `<div class="pip ${cls}" style="grid-row: ${r}; grid-column: ${c};"></div>`;
        
        let pips = '';
        if (val === 1) {
            pips = mkPip(2, 2, 'red big');
        } else if (val === 2) {
            pips = mkPip(1, 3) + mkPip(3, 1); // Top-Right, Bottom-Left usually
        } else if (val === 3) {
            pips = mkPip(1, 3) + mkPip(2, 2) + mkPip(3, 1); // Diagonal /
        } else if (val === 4) {
            pips = mkPip(1, 1, 'red') + mkPip(1, 3, 'red') + mkPip(3, 1, 'red') + mkPip(3, 3, 'red');
        } else if (val === 5) {
            pips = mkPip(1, 1) + mkPip(1, 3) + mkPip(2, 2) + mkPip(3, 1) + mkPip(3, 3);
        } else if (val === 6) {
            pips = mkPip(1, 1) + mkPip(1, 3) + mkPip(2, 1) + mkPip(2, 3) + mkPip(3, 1) + mkPip(3, 3);
        }
        return pips;
    }

    function resetWallVisual() {
        // Reset all walls colors
        for(let i=0; i<4; i++) {
            const grp = document.getElementById(`wall-${i}`);
            if(grp) {
                const rect = grp.querySelector('rect');
                const txt = grp.querySelector('text');
                if(rect) { 
                    rect.setAttribute('fill', '#444'); 
                    rect.setAttribute('stroke', '#666'); 
                    rect.setAttribute('stroke-width', '1');
                }
                if(txt) { txt.setAttribute('fill', '#fff'); }
                
                // Remove existing indicator if any
                const oldInd = grp.querySelector('.cut-indicator');
                if(oldInd) oldInd.remove();
            }
        }
    }

    function updateWallVisual(wallIdx, sum) {
        const grp = document.getElementById(`wall-${wallIdx}`);
        if(!grp) return;

        const rect = grp.querySelector('rect');
        const txt = grp.querySelector('text');
        
        // Highlight active wall
        if(rect) { 
            rect.setAttribute('fill', '#34495e'); 
            rect.setAttribute('stroke', '#00c6ff'); 
            rect.setAttribute('stroke-width', '2');
        }
        if(txt) txt.setAttribute('fill', '#00c6ff');

        // Add Indicator
        const stackWidth = 120 / 17;
        let xPos;

        // Even walls (0, 2): Right is Local +60. Count decreases X.
        // Odd walls (1, 3): Right is Local -60. Count increases X.
        if (wallIdx % 2 === 0) {
            xPos = 60 - (sum * stackWidth);
        } else {
            xPos = -60 + (sum * stackWidth);
        }

        // Logic adjusted for specific wall rotations:
        // Wall 0 (Self) & 2 (Across): Inside is -Y local.
        // Wall 1 (Right) & 3 (Left): Inside is +Y local.
        const isSideWall = (wallIdx === 1 || wallIdx === 3);
        
        const yPos = isSideWall ? 10 : -10; // Arrow tip position
        const arrowRot = isSideWall ? 180 : 0; // 0 points +Y (towards wall 0/2), 180 points -Y (towards wall 1/3)
        const textOffset = isSideWall ? 30 : -30; // Number position (further inside)
        
        // Counter-rotations for text to stay upright
        const wallRots = [0, 90, 180, -90];
        const textRot = -wallRots[wallIdx];
        
        const textY = textOffset;

        // Create indicator group
        const indGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        indGroup.setAttribute('class', 'cut-indicator');
        indGroup.setAttribute('transform', `translate(${xPos}, ${yPos})`);
        
        // Arrow Path (Triangle pointing to local 0,0)
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute('d', 'M0,0 L-5,-8 L5,-8 Z'); 
        path.setAttribute('fill', '#FFD700');
        path.setAttribute('filter', 'drop-shadow(0 0 2px rgba(0,0,0,0.5))');
        path.setAttribute('transform', `rotate(${arrowRot})`);
        
        // Text
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute('x', '0');
        text.setAttribute('y', textY);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#FFD700');
        text.setAttribute('font-size', '14'); 
        text.setAttribute('font-weight', 'bold');
        
        // Apply rotation around the text position itself to keep it upright
        text.setAttribute('transform', `rotate(${textRot} 0 ${textY})`);
        text.textContent = sum; 
        
        indGroup.appendChild(path);
        indGroup.appendChild(text);
        
        // Append to the wall group
        grp.appendChild(indGroup);
    }

    function rollDice() {
        const c1 = document.getElementById('cube1');
        const c2 = document.getElementById('cube2');
        const sumDisplay = document.getElementById('diceSum');
        const dirDisplay = document.getElementById('wallDirDisplay');
        
        // Reset Visual
        resetWallVisual();

        // Random values 1-6
        const v1 = Math.floor(Math.random() * 6) + 1;
        const v2 = Math.floor(Math.random() * 6) + 1;
        
        // Target Rotations for each face to be FRONT
        // 1: Y 0, 2: Y -90, 3: Y -180, 4: Y 90, 5: X -90, 6: X 90
        const faceTargets = {
            1: {x: 0, y: 0},
            2: {x: 0, y: -90},
            3: {x: 0, y: -180},
            4: {x: 0, y: 90},
            5: {x: -90, y: 0},
            6: {x: 90, y: 0}
        };

        const minSpin = 720; // At least 2 full spins

        // Helper to calculate next rotation
        const getNextRot = (current, target) => {
            // Find k such that: target + k*360 >= current + minSpin
            const diff = current + minSpin - target;
            const k = Math.ceil(diff / 360);
            return target + (k * 360);
        };
        
        // Update Die 1
        const t1 = faceTargets[v1];
        const extra1 = Math.floor(Math.random() * 2) * 360; 
        
        const nextX1 = getNextRot(diceState[1].x, t1.x) + extra1;
        const nextY1 = getNextRot(diceState[1].y, t1.y) + extra1;
        
        diceState[1] = {x: nextX1, y: nextY1};
        c1.style.transform = `rotateX(${nextX1}deg) rotateY(${nextY1}deg)`;

        // Update Die 2
        const t2 = faceTargets[v2];
        const extra2 = Math.floor(Math.random() * 2) * 360; 

        const nextX2 = getNextRot(diceState[2].x, t2.x) + extra2;
        const nextY2 = getNextRot(diceState[2].y, t2.y) + extra2;
        
        diceState[2] = {x: nextX2, y: nextY2};
        c2.style.transform = `rotateX(${nextX2}deg) rotateY(${nextY2}deg)`;

        // Update Text after animation
        sumDisplay.textContent = '...';
        dirDisplay.textContent = '...'; 

        setTimeout(() => {
            const sum = v1 + v2;
            const breakPoint = Math.min(v1, v2);
            sumDisplay.textContent = sum;
            const dirIndex = (sum - 1) % 4;
            dirDisplay.textContent = `${WALL_START_LABEL}: ${WALL_DIRS[dirIndex]} (${breakPoint})`;
            
            updateWallVisual(dirIndex, breakPoint);
        }, 1500); // Matches transition duration
    }
</script>
</body>
</html>
